name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'

jobs:
  # ──────────────────────────────────────────────────
  # Lint & Type Check
  # ──────────────────────────────────────────────────
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run ESLint
        run: npm run lint

      - name: Run TypeScript type checking
        run: npm run type-check

  # ──────────────────────────────────────────────────
  # Unit & Integration Tests
  # ──────────────────────────────────────────────────
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Run tests
        run: npm run test:ci

      - name: Run test coverage
        run: npm run test:coverage

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 14

  # ──────────────────────────────────────────────────
  # Build
  # ──────────────────────────────────────────────────
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Build application
        run: npm run build
        env:
          # Provide dummy env vars so the build doesn't fail
          DATABASE_URL: 'postgresql://dummy:dummy@localhost:5432/dummy'
          UPSTASH_REDIS_URL: 'https://dummy.upstash.io'
          UPSTASH_REDIS_TOKEN: 'dummy_token'
          RESEND_API_KEY: 'dummy_key'
          NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME: 'dummy'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: .next/
          retention-days: 7

  # ──────────────────────────────────────────────────
  # Deploy (only on push to main)
  # ──────────────────────────────────────────────────
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # ── Vercel Deployment ──
      # Uncomment and configure once Vercel is set up:
      #
      # - name: Install Vercel CLI
      #   run: npm i -g vercel@latest
      #
      # - name: Pull Vercel environment
      #   run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
      #
      # - name: Build for Vercel
      #   run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
      #
      # - name: Deploy to Vercel
      #   run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deployment placeholder
        run: echo "✅ All checks passed. Configure deployment target (Vercel/Railway/etc.) in this step."
