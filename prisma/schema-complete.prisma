// Complete Prisma Schema for IndiaNext
// This is the production-ready normalized schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ═══════════════════════════════════════════════════════════
// USERS & AUTHENTICATION
// ═══════════════════════════════════════════════════════════

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  phone         String?
  
  // Academic Info
  college       String?
  degree        String?
  year          String?
  branch        String?
  
  // Profile
  avatar        String?   // Cloudinary URL
  bio           String?   @db.Text
  linkedIn      String?
  github        String?
  portfolio     String?
  
  // Auth & Security
  emailVerified Boolean   @default(false)
  role          UserRole  @default(PARTICIPANT)
  lastLoginAt   DateTime?
  lastLoginIp   String?
  
  // Metadata
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete

  // Relations
  teamMemberships TeamMember[]
  otps            Otp[]
  sessions        Session[]
  activityLogs    ActivityLog[]
  notifications   Notification[]
  createdTeams    Team[]        @relation("TeamCreator")

  @@index([email])
  @@index([college])
  @@index([role])
  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model Otp {
  id        String     @id @default(cuid())
  email     String
  otp       String
  purpose   OtpPurpose @default(REGISTRATION)
  expiresAt DateTime
  verified  Boolean    @default(false)
  attempts  Int        @default(0)
  userId    String?
  user      User?      @relation(fields: [userId], references: [id])
  createdAt DateTime   @default(now())
  verifiedAt DateTime?

  @@unique([email, purpose])
  @@index([email])
  @@index([expiresAt])
  @@map("otps")
}

// ═══════════════════════════════════════════════════════════
// TEAMS & REGISTRATIONS
// ═══════════════════════════════════════════════════════════

model Team {
  id        String   @id @default(cuid())
  name      String
  track     Track
  status    RegistrationStatus @default(PENDING)
  
  // Team metadata
  size      Int      @default(1)
  college   String?  // Primary college (from leader)
  
  // Registration details
  hearAbout       String?
  additionalNotes String?  @db.Text
  referralCode    String?
  
  // Admin fields
  createdBy       String?  // User ID who created the team
  creator         User?    @relation("TeamCreator", fields: [createdBy], references: [id])
  reviewedBy      String?  // Admin user ID
  reviewedAt      DateTime?
  reviewNotes     String?  @db.Text
  rejectionReason String?  @db.Text
  
  // Scoring (for judging phase)
  score           Float?
  rank            Int?
  
  // Metadata
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime? // Soft delete
  
  // Relations
  members    TeamMember[]
  submission Submission?
  comments   Comment[]
  tags       TeamTag[]

  @@index([track, status])
  @@index([college])
  @@index([status, createdAt])
  @@index([rank])
  @@index([createdBy])
  @@fulltext([name])
  @@map("teams")
}

model TeamMember {
  id        String     @id @default(cuid())
  role      MemberRole @default(MEMBER)
  userId    String
  teamId    String
  
  // Member-specific data
  joinedAt  DateTime   @default(now())
  leftAt    DateTime?  // If member leaves
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([teamId])
  @@index([userId])
  @@map("team_members")
}

// ═══════════════════════════════════════════════════════════
// SUBMISSIONS & FILES
// ═══════════════════════════════════════════════════════════

model Submission {
  id     String @id @default(cuid())
  teamId String @unique
  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  // IdeaSprint fields
  ideaTitle        String?
  problemStatement String?  @db.Text
  proposedSolution String?  @db.Text
  targetUsers      String?  @db.Text
  expectedImpact   String?  @db.Text
  techStack        String?  @db.Text
  marketSize       String?
  competitors      String?  @db.Text
  
  // BuildStorm fields
  problemDesc      String?  @db.Text
  githubLink       String?
  demoLink         String?
  techStackUsed    String?  @db.Text
  challenges       String?  @db.Text
  futureScope      String?  @db.Text
  
  // Judging
  judgeScore       Float?
  judgeComments    String?  @db.Text
  
  // Metadata
  submittedAt DateTime?
  lastEditedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  files File[]

  @@index([teamId])
  @@fulltext([ideaTitle, problemStatement])
  @@map("submissions")
}

model File {
  id           String  @id @default(cuid())
  submissionId String
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)

  fileName    String
  fileUrl     String   // Cloudinary URL
  fileKey     String   @unique // Cloudinary public_id
  fileSize    Int      // bytes
  mimeType    String
  category    FileCategory
  
  // File metadata
  checksum    String?  // SHA-256 for deduplication
  thumbnail   String?  // Cloudinary thumbnail URL
  width       Int?     // For images
  height      Int?     // For images
  duration    Int?     // For videos (seconds)
  
  // Virus scanning
  scanStatus  ScanStatus @default(PENDING)
  scanResult  String?
  
  uploadedAt DateTime @default(now())
  uploadedBy String?  // User ID

  @@index([submissionId])
  @@index([fileKey])
  @@index([scanStatus])
  @@index([category])
  @@map("files")
}

// ═══════════════════════════════════════════════════════════
// ADMIN & MODERATION
// ═══════════════════════════════════════════════════════════

model Comment {
  id        String   @id @default(cuid())
  teamId    String
  authorId  String   // Admin/Organizer user ID
  content   String   @db.Text
  isInternal Boolean @default(true) // Internal notes vs public feedback
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@index([teamId])
  @@index([authorId])
  @@index([createdAt])
  @@map("comments")
}

model TeamTag {
  id     String @id @default(cuid())
  teamId String
  tag    String // e.g., "high-potential", "needs-review", "finalist"
  color  String @default("#6366f1") // Hex color for UI
  
  addedBy   String   // Admin user ID
  addedAt   DateTime @default(now())
  
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  
  @@unique([teamId, tag])
  @@index([tag])
  @@map("team_tags")
}

// ═══════════════════════════════════════════════════════════
// ACTIVITY & AUDIT LOGS
// ═══════════════════════════════════════════════════════════

model ActivityLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String   // e.g., "team.created", "submission.updated"
  entity    String   // e.g., "Team", "Submission"
  entityId  String
  metadata  Json?    // Additional context
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id])
  
  @@index([userId])
  @@index([action])
  @@index([entityId])
  @@index([createdAt])
  @@map("activity_logs")
}

// ═══════════════════════════════════════════════════════════
// NOTIFICATIONS
// ═══════════════════════════════════════════════════════════

model Notification {
  id      String   @id @default(cuid())
  userId  String
  type    NotificationType
  title   String
  message String   @db.Text
  link    String?
  read    Boolean  @default(false)
  
  createdAt DateTime @default(now())
  readAt    DateTime?
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

// ═══════════════════════════════════════════════════════════
// ANALYTICS & METRICS
// ═══════════════════════════════════════════════════════════

model Metric {
  id        String   @id @default(cuid())
  name      String   // e.g., "registrations_count", "avg_team_size"
  value     Float
  metadata  Json?
  timestamp DateTime @default(now())
  
  @@index([name, timestamp])
  @@map("metrics")
}

// ═══════════════════════════════════════════════════════════
// EMAIL CAMPAIGNS
// ═══════════════════════════════════════════════════════════

model EmailCampaign {
  id          String   @id @default(cuid())
  name        String
  subject     String
  body        String   @db.Text
  status      CampaignStatus @default(DRAFT)
  
  // Filters for recipients
  filters     Json?    // { track: "IDEA_SPRINT", status: "APPROVED" }
  
  // Stats
  totalSent   Int      @default(0)
  totalOpened Int      @default(0)
  totalClicked Int     @default(0)
  
  createdBy   String
  createdAt   DateTime @default(now())
  sentAt      DateTime?
  
  @@index([status])
  @@index([createdAt])
  @@map("email_campaigns")
}

// ═══════════════════════════════════════════════════════════
// ENUMS
// ═══════════════════════════════════════════════════════════

enum UserRole {
  PARTICIPANT
  ORGANIZER
  JUDGE
  ADMIN
  SUPER_ADMIN
}

enum Track {
  IDEA_SPRINT
  BUILD_STORM
}

enum MemberRole {
  LEADER
  MEMBER
  CO_LEADER
}

enum RegistrationStatus {
  DRAFT          // Started but not submitted
  PENDING        // Submitted, awaiting review
  UNDER_REVIEW   // Being reviewed by admin
  APPROVED       // Accepted
  REJECTED       // Not accepted
  WAITLISTED     // On waitlist
  WITHDRAWN      // Team withdrew
}

enum FileCategory {
  IDEA_DECK
  PITCH_VIDEO
  ARCHITECTURE_DIAGRAM
  DEMO_VIDEO
  SUPPORTING_DOC
  PROTOTYPE
  PRESENTATION
  OTHER
}

enum ScanStatus {
  PENDING
  CLEAN
  INFECTED
  ERROR
}

enum OtpPurpose {
  REGISTRATION
  LOGIN
  PASSWORD_RESET
  EMAIL_VERIFICATION
}

enum NotificationType {
  STATUS_UPDATE
  COMMENT
  DEADLINE_REMINDER
  ANNOUNCEMENT
  SYSTEM
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}
